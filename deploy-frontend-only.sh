#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´ÐµÐ¿Ð»Ð¾Ñ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Frontend Ð´Ð»Ñ Komi Republic
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: sudo ./deploy-frontend-only.sh

set -e  # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ

echo "ðŸš€ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Frontend Komi Republic..."

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$SCRIPT_DIR"
FRONTEND_DIR="$PROJECT_DIR/komi-republic-frontend"
NGINX_CONFIG="/etc/nginx/sites-available/komi-republic"
SERVER_IP="158.160.167.43"

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² root
if [ "$EUID" -ne 0 ]; then 
    log_error "Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ root: sudo ./deploy-frontend-only.sh"
    exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ frontend
log_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
log_info "Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $PROJECT_DIR"

if [ ! -d "$FRONTEND_DIR" ]; then
    log_error "ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ frontend: $FRONTEND_DIR"
    exit 1
fi

log_info "âœ“ Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ frontend Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"

# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ (ÐµÑÐ»Ð¸ ÑÑ‚Ð¾ git)
if [ -d ".git" ]; then
    log_info "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
    git pull origin main || log_warn "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ (Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾, ÐµÑÑ‚ÑŒ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ)"
fi

# Ð”ÐµÐ¿Ð»Ð¾Ð¹ Frontend
log_info "Ð”ÐµÐ¿Ð»Ð¾Ð¹ Frontend..."
cd $FRONTEND_DIR

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
if [ -d "node_modules" ]; then
    log_info "ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
    rm -rf node_modules package-lock.json
fi

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ð¾Ð¹ ÑÐ±Ð¾Ñ€ÐºÐ¸
if [ -d "dist" ]; then
    log_info "ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ð¾Ð¹ ÑÐ±Ð¾Ñ€ÐºÐ¸..."
    rm -rf dist
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ/Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°
log_info "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°..."
cat > .env << EOF
VITE_STRAPI_URL=http://$SERVER_IP:1337
EOF

log_info "âœ“ .env Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½"

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
log_info "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ (ÑÑ‚Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð½ÑÑ‚ÑŒ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¼Ð¸Ð½ÑƒÑ‚)..."
npm install

# Ð¡Ð±Ð¾Ñ€ÐºÐ°
log_info "Ð¡Ð±Ð¾Ñ€ÐºÐ° Frontend..."
npm run build

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ÑÑ‚Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ¸
if [ ! -d "dist" ] || [ ! -f "dist/index.html" ]; then
    log_error "ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸! Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ dist Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð° Ð¸Ð»Ð¸ Ð¿ÑƒÑÑ‚Ð°"
    exit 1
fi

log_info "âœ“ Frontend ÑÐ¾Ð±Ñ€Ð°Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"

# Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ð´Ð»Ñ Nginx
log_info "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°..."
chmod 755 /home/maryayukhnina
chmod 755 /home/maryayukhnina/komi-republic
chmod 755 "$FRONTEND_DIR"
chmod 755 "$FRONTEND_DIR/dist"
chmod -R 755 "$FRONTEND_DIR/dist"/*

log_info "âœ“ ÐŸÑ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹"

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx
log_info "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx..."
cat > $NGINX_CONFIG << EOF
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name $SERVER_IP;

    # Frontend
    location / {
        root $FRONTEND_DIR/dist;
        try_files \$uri \$uri/ /index.html;
        
        # ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # Backend API
    location /api {
        proxy_pass http://localhost:1337;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_cache_bypass \$http_upgrade;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    # Strapi Admin
    location /admin {
        proxy_pass http://localhost:1337;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_cache_bypass \$http_upgrade;
    }

    # Ð—Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
    location /uploads {
        proxy_pass http://localhost:1337;
    }

    # Gzip ÑÐ¶Ð°Ñ‚Ð¸Ðµ
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
}
EOF

log_info "âœ“ ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Nginx Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°"

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ ÑÑÑ‹Ð»ÐºÐ¸ (ÐµÑÐ»Ð¸ ÐµÑ‰Ðµ Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð°)
if [ ! -L "/etc/nginx/sites-enabled/komi-republic" ]; then
    log_info "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ ÑÑÑ‹Ð»ÐºÐ¸..."
    rm -f /etc/nginx/sites-enabled/default
    ln -sf $NGINX_CONFIG /etc/nginx/sites-enabled/
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx
log_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx..."
nginx -t

if [ $? -ne 0 ]; then
    log_error "ÐžÑˆÐ¸Ð±ÐºÐ° Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx!"
    exit 1
fi

# ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Nginx
log_info "ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Nginx..."
systemctl restart nginx

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Nginx
if systemctl is-active --quiet nginx; then
    log_info "âœ“ Nginx Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
else
    log_error "Nginx Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»ÑÑ!"
    systemctl status nginx
    exit 1
fi

# Ð’Ñ‹Ð²Ð¾Ð´ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ ÑÐ±Ð¾Ñ€ÐºÐµ
log_info ""
log_info "================================"
log_info "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Frontend Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
log_info "================================"
log_info ""
log_info "ðŸ“ Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸: $FRONTEND_DIR/dist"
log_info "ðŸ“ ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Nginx: $NGINX_CONFIG"
log_info "ðŸŒ Frontend: http://$SERVER_IP"
log_info ""
log_info "Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ dist:"
ls -lh "$FRONTEND_DIR/dist"
log_info ""
log_info "ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
log_info "  - Ð›Ð¾Ð³Ð¸ Nginx: sudo tail -f /var/log/nginx/error.log"
log_info "  - ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Nginx: sudo systemctl restart nginx"
log_info "  - ÐŸÐµÑ€ÐµÑÐ±Ð¾Ñ€ÐºÐ° Frontend: cd $FRONTEND_DIR && npm run build"
log_info ""
log_warn "âš ï¸  ÐÐµ Ð·Ð°Ð±ÑƒÐ´ÑŒÑ‚Ðµ:"
log_warn "  1. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ ÑÐ°Ð¹Ñ‚Ð°: http://$SERVER_IP"
log_warn "  2. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Strapi API (ÐµÑÐ»Ð¸ ÐµÑ‰Ðµ Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¾)"
log_warn "  3. Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ Ð² Strapi"
