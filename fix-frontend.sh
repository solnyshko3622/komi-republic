dc#!/bin/bash

# Ð‘Ñ‹ÑÑ‚Ñ€Ð¾Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ frontend

echo "ðŸ”§ Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ frontend..."

# ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¿ÑƒÑ‚Ð¸
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FRONTEND_DIR="$SCRIPT_DIR/komi-republic-frontend"
NGINX_CONFIG="/etc/nginx/sites-available/komi-republic"
SERVER_IP="158.160.167.43"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² root
if [ "$EUID" -ne 0 ]; then 
    echo "âŒ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ root: sudo ./fix-frontend.sh"
    exit 1
fi

echo "ðŸ“ Frontend Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $FRONTEND_DIR"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÐ¾Ð±Ñ€Ð°Ð½ Ð»Ð¸ frontend
if [ ! -d "$FRONTEND_DIR/dist" ]; then
    echo "âš ï¸  Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ dist Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°. Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ frontend..."
    cd $FRONTEND_DIR
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ .env
    if [ ! -f ".env" ]; then
        echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°..."
        cat > .env << EOF
VITE_STRAPI_URL=http://$SERVER_IP:1337
EOF
    fi
    
    # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼
    echo "ðŸ”¨ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ°..."
    npm install
    npm run build
else
    echo "âœ… Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ dist Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ dist
echo "ðŸ“‹ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ dist:"
ls -la "$FRONTEND_DIR/dist" | head -10

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Nginx Ñ Ð°Ð±ÑÐ¾Ð»ÑŽÑ‚Ð½Ñ‹Ð¼Ð¸ Ð¿ÑƒÑ‚ÑÐ¼Ð¸
echo "ðŸ”§ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx..."
cat > $NGINX_CONFIG << EOF
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name $SERVER_IP;

    # Frontend
    location / {
        root $FRONTEND_DIR/dist;
        try_files \$uri \$uri/ /index.html;
        
        # ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # Backend API
    location /api {
        proxy_pass http://localhost:1337;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_cache_bypass \$http_upgrade;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    # Strapi Admin
    location /admin {
        proxy_pass http://localhost:1337;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_cache_bypass \$http_upgrade;
    }

    # Ð—Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
    location /uploads {
        proxy_pass http://localhost:1337;
    }

    # Gzip ÑÐ¶Ð°Ñ‚Ð¸Ðµ
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
}
EOF

echo "ðŸ“ ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Nginx Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°"
echo "ðŸ“ Root Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $FRONTEND_DIR/dist"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx..."
nginx -t

if [ $? -eq 0 ]; then
    echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Nginx ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð°"
    
    # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Nginx
    echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Nginx..."
    systemctl restart nginx
    
    echo ""
    echo "================================"
    echo "âœ… Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
    echo "================================"
    echo "ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ: http://$SERVER_IP"
    echo ""
    echo "Ð•ÑÐ»Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð° ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ÑÑ, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ:"
    echo "  1. Ð›Ð¾Ð³Ð¸ Nginx: sudo tail -f /var/log/nginx/error.log"
    echo "  2. Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ dist: ls -la $FRONTEND_DIR/dist"
    echo "  3. ÐŸÑ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°: ls -ld $FRONTEND_DIR/dist"
else
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx"
    exit 1
fi
